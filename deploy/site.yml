---

# TODO: Ensure that the process that the nodejs apps (central, workers) run under (currently 'www')
# has limited access. The user should not be a login user. Central should only have write access to
# /var/log/clients/, and the workers should have no write access (Supervisor takes care of writing
# their stdout/stderr to /var/log/...). They should have read-only access to their app folder and
# the global npm directory (including the global npm config file.) They may also need access for
# CUDA/OpenCL stuff.


- hosts: localhost
  roles:
    - { role: slack, message: "{{ cluster | capitalize }} deploy started..." }
  tags:
    - provision
    - deploy
    - local

- hosts: workers:central
  roles:
   - { role: common, sudo: yes, tags: [ 'common' ] }
   - { role: users, tags: [ 'users' ] }
   - { role: splunkfwd, sudo: yes }
   - { role: nodejs, tags: [ 'nodejs' ] }
  tags:
    - provision

- hosts: workers
  roles:
   - { role: worker, tags: [ 'provision' ] }
   - { role: viz-app, sudo: yes, sudo_user: www, tags: [ 'deploy', 'worker-deploy' ] }
  gather_facts: yes
  tags: workers

- hosts: central
  roles:
   - { role: central, sudo: yes, sudo_user: www, tags: [ 'deploy', 'central-deploy' ] }
  gather_facts: yes
  tags: central


- hosts: localhost
  roles:
    - { role: slack, message: "   ...{{ cluster }} deploy done! Access at {{ www_url }}." }
  tags:
    - provision
    - deploy
    - local
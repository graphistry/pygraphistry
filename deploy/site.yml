---

# TODO: Ensure that the process that the nodejs apps (central, workers) run under (currently 'www')
# has limited access. No home folder, only has read-only access to npm modules used, no access to
# .git directories, ideally no access to any SSH keys, can only write to /var/log/clients.log.

# TODO: Automatically clear the MongoDB when deploying

# TODO: Secure sensitive data:
# * Username/password variable files should be encrypted and/or distributed out-of-band.
# * No SSH deploy key in repo (refactor GitHub tasks to use SSH agent forwarding).
# * No Ansible SSH private key in repo (users use their own SSH keys to log in either as `ubuntu`,
#   like present, or even as their own user account.)
# * Review account creation and permissions on 'production' machines.
# * Consider requiring passwords for `sudo` (refactor Ansible to prompt users for sudo password.)


- hosts: localhost
  roles:
    - { role: slack, message: "{{ cluster | capitalize }} deploy started..." }
  tags:
    - provision
    - deploy
    - local

- hosts: workers:central
  roles:
   - { role: app_server, tags: [ 'app_server' ] }
  tags:
    - provision

- hosts: workers
  roles:
   - { role: worker, tags: [ 'provision' ] }
   - { role: viz-app, sudo: yes, sudo_user: www, tags: [ 'deploy', 'worker-deploy' ] }
  gather_facts: yes
  tags: workers

- hosts: central
  roles:
   - { role: central, sudo: yes, sudo_user: www, tags: [ 'deploy', 'central-deploy' ] }
  gather_facts: yes
  tags: central


- hosts: localhost
  roles:
    - { role: slack, message: "   ...{{ cluster }} deploy done! Access at http://{{ groups['central'][0] }}." }
  tags:
    - provision
    - deploy
    - local

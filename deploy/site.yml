---

# FIXME: Only refresh the apt-cache when installing nodejs if we installed new repos
# FIXME: Only restart splunk service if we've changed its config


- hosts: localhost
  roles:
    - { role: version_check, sudo: no }
    - { role: slack, message: "{{ cluster | capitalize }} deploy started..." }
  tags:
    - provision
    - deploy
    - local

- hosts: workers:central
  roles:
   - { role: version_check, sudo: no }
   - { role: common, sudo: yes }
   - { role: users, tags: [ 'users' ] }
   - { role: splunkfwd, sudo: yes }
   - { role: nodejs, tags: [ 'nodejs' ] }
  tags:
    - common
    - provision

- hosts: workers
  roles:
   - { role: version_check, sudo: no, tags: [ 'worker-deploy' ] }
   - { role: worker, tags: [ 'provision' ] }
   - { role: viz-app, sudo: yes, sudo_user: www, tags: [ 'deploy', 'worker-deploy' ] }
  tags: workers

- hosts: central
  roles:
   - { role: version_check, sudo: no, tags: [ 'central-deploy' ] }
   - { role: central, sudo: yes, sudo_user: www, tags: [ 'deploy', 'central-deploy' ] }
  tags: central

- hosts: localhost
  roles:
    - { role: version_check, sudo: no }
    - { role: slack, message: "   ...{{ cluster }} deploy done! Access at {{ www_url }}." }
  tags:
    - provision
    - deploy
    - local
---
- hosts: localhost
  gather_facts: no
  roles:
    - { role: slack, message: "{{ cluster | capitalize }} deploy started..." }
  tags:
    - provision
    - deploy

- hosts: all
  # gather_facts runs before roles. If not disabled, Ansible will try to connect to on port 61630,
  # before we've set sshd to listen on that port, causing a fatal error before we even start.
  gather_facts: no
  roles:
    - { role: sshd_port, tags: [ 'sshd', 'provision' ] }

- hosts: all
  roles:
    - { role: common, become: yes, tags: [ 'common' ] }
    - { role: users, tags: [ 'users' ] }
    - { role: splunkfwd, sudo: yes, tags: [ 'splunkfwd' ] }
  tags:
    - provision

- hosts: app_servers
  roles:
   - { role: cuda, tags: [ 'cuda' ] }
   - { role: nodejs, tags: [ 'nodejs' ] }
   - { role: app_server, tags: [ 'app_servers' ] }
  tags:
    - provision
    - workers
    - central

- hosts: central
  roles:
   - { role: mongo, tags: [ 'mongo' , 'provision' ] }
   - { role: proxy, tags: [ 'proxy' , 'deploy' ] }
   - { role: central, sudo: yes, sudo_user: www, tags: [ 'deploy' ] }
  tags:
    - central

- hosts: workers
  roles:
   - { role: worker, sudo: yes, sudo_user: www, tags: [ 'deploy' ] }
  tags:
    - workers

- hosts: localhost
  gather_facts: no
  roles:
    - { role: slack, message: "   ...{{ cluster }} deploy done! Access at http://{{ groups['central'][0] }}." }
  tags:
    - provision
    - deploy

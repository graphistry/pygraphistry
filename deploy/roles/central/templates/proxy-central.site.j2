upstream proxy-central {
    server 127.0.0.1:3000;
    keepalive 256;
}

upstream proxy-splunk {
    server {{ splunk_url }};
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;

    server_name proxy-{{ inventory_hostname }};

    proxy_http_version      1.1;
    proxy_set_header        Connection       "";
    proxy_set_header        Host            $host;
    proxy_set_header        X-Real-IP       $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

    location ~* ^/(vizaddr|error)(/.*)? {
        proxy_pass              http://proxy-central;
        proxy_cache             off;
    }
    location /etl {
        proxy_pass              http://proxy-central;
        proxy_cache             off;
        proxy_buffering         off;
    }

    location ~* ^/(graphistry|graph|horizon|uber|api)/?.* {
        proxy_pass              http://proxy-central;
    }

    location ~* /StreamGL\.(js|map)$ {
        proxy_pass              http://proxy-central;
    }

    location ~* ^/worker/(?<worker_port>100[0-9][0-9])/?.* {
        rewrite                 ^/worker/(100[0-9][0-9])(/?.*)$ $2 break;
        proxy_pass              http://127.0.0.1:$worker_port;

        proxy_cache             off;
        proxy_buffering         off;

        proxy_set_header        Upgrade $http_upgrade;
        proxy_set_header        Connection $connection_upgrade;

        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /splunk {
        return                  301 /en-us/;
    }

    location = / {
        return                  301 /graphistry/;
    }

    location / {
        proxy_pass              http://proxy-splunk;
        proxy_http_version      1.1;
        proxy_set_header        Connection       "";
        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
